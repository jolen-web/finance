{% extends "base.html" %}

{% block title %}AI Transaction Categorizer - Finance Tracker{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <h1><i class="fas fa-robot"></i> AI Transaction Categorizer</h1>
        <p class="text-muted">Machine learning powered transaction categorization</p>
    </div>
</div>

<!-- Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title text-muted">Total Transactions</h5>
                <h2>{{ stats.total_transactions }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title text-muted">Categorized</h5>
                <h2>{{ stats.categorized_transactions }}</h2>
                <small class="text-muted">{{ stats.categorized_percentage }}%</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title text-muted">Uncategorized</h5>
                <h2>{{ stats.uncategorized_transactions }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title text-muted">Active Rules</h5>
                <h2>{{ stats.active_rules }}</h2>
            </div>
        </div>
    </div>
</div>

<!-- Model Status -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-brain"></i> Model Status</h5>
            </div>
            <div class="card-body">
                {% if model_status.is_trained %}
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> Model is trained and ready
                    </div>
                    <p><strong>Training Samples:</strong> {{ model_status.training_samples }}</p>
                    <p><strong>Categories:</strong> {{ model_status.num_categories }}</p>
                    <p><strong>Last Trained:</strong> {{ model_status.last_trained or 'Just now' }}</p>
                {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> Model not trained yet
                    </div>
                    <p>Train the model with your existing categorized transactions to enable auto-categorization.</p>
                {% endif %}

                <form method="POST" action="{{ url_for('ai_categorizer.train') }}" class="mt-3">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i> {% if model_status.is_trained %}Retrain{% else %}Train{% endif %} Model
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-magic"></i> Auto-Categorize</h5>
            </div>
            <div class="card-body">
                {% if model_status.is_trained %}
                    <p>Automatically categorize uncategorized transactions using the trained model.</p>
                    <form method="POST" action="{{ url_for('ai_categorizer.auto_categorize') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                        <div class="mb-3">
                            <label for="confidence_threshold" class="form-label">Minimum Confidence</label>
                            <input type="range" class="form-range" id="confidence_threshold" name="confidence_threshold"
                                   min="50" max="95" value="80" step="5">
                            <small class="text-muted">Current: <span id="confidence_value">80</span>%</small>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-wand-magic-sparkles"></i> Auto-Categorize Transactions
                        </button>
                    </form>
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Train the model first to enable auto-categorization.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Top Rules -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list"></i> Top Categorization Rules</h5>
                <a href="{{ url_for('ai_categorizer.rules') }}" class="btn btn-sm btn-outline-primary">
                    View All Rules
                </a>
            </div>
            <div class="card-body">
                {% if top_rules %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Payee Pattern</th>
                                    <th>Category</th>
                                    <th>Confidence</th>
                                    <th>Usage Count</th>
                                    <th>Auto-Learned</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for rule in top_rules %}
                                    <tr>
                                        <td><code>{{ rule.payee_pattern }}</code></td>
                                        <td>
                                            {% if rule.category %}
                                                <span class="badge bg-primary">{{ rule.category.name }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Uncategorized</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="progress" style="width: 100px;">
                                                <div class="progress-bar" role="progressbar"
                                                     style="width: {{ rule.confidence_score }}%"
                                                     aria-valuenow="{{ rule.confidence_score }}"
                                                     aria-valuemin="0" aria-valuemax="100">
                                                    {{ rule.confidence_score|round|int }}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ rule.usage_count }}</td>
                                        <td>
                                            {% if rule.is_auto_learned %}
                                                <i class="fas fa-robot text-success"></i> Auto
                                            {% else %}
                                                <i class="fas fa-user text-primary"></i> Manual
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No categorization rules yet. Train the model to create rules.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- How It Works -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-question-circle"></i> How It Works</h5>
            </div>
            <div class="card-body">
                <ol>
                    <li><strong>Train the Model:</strong> The AI learns from your existing categorized transactions using machine learning (TF-IDF + Naive Bayes).</li>
                    <li><strong>Auto-Categorize:</strong> Uncategorized transactions are automatically assigned categories based on learned patterns.</li>
                    <li><strong>Confidence Threshold:</strong> Only predictions above your chosen confidence level are applied automatically.</li>
                    <li><strong>Continuous Learning:</strong> As you categorize more transactions, the model improves its accuracy.</li>
                    <li><strong>Rules Management:</strong> View and manage learned categorization rules to fine-tune behavior.</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Update confidence value display
document.getElementById('confidence_threshold').addEventListener('input', function(e) {
    document.getElementById('confidence_value').textContent = e.target.value;
});
</script>
{% endblock %}
